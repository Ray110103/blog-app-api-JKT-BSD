generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             Int      @id @default(autoincrement())
  name           String
  email          String   @unique
  password       String?
  role           Role     @default(USER)
  pictureProfile String?
  isVerified     Boolean  @default(false)

  provider   String?
  providerId String?
  avatar     String?

  pendingEmail           String?
  emailVerificationToken String?
  emailTokenExpiry       DateTime?

  resetPasswordToken  String?
  resetPasswordExpiry DateTime?

  isActive  Boolean   @default(true)
  lastLogin DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses       Address[]
  orders          Order[]
  cart            Cart?
  wishlist        Wishlist[]
  reviews         Review[]
  blogPosts       BlogPost[]
  blogComments    BlogComment[]
  complaints      Complaint[]  @relation("UserComplaints")
  adminComplaints Complaint[]  @relation("AdminComplaints")

  bids                Bid[]
  wonAuctions         Auction[]          @relation("AuctionWinner")
  createdAuctions     Auction[]          @relation("AuctionCreator")
  auctionStats        UserAuctionStats?
  auctionFailures     AuctionFailure[]

  @@map("users")
}

enum Role {
  ADMIN
  USER
}

model Game {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String
  description String?  @db.Text
  thumbnail   String?
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sets     Set[]
  products Product[]

  @@map("games")
}

model Language {
  id       Int     @id @default(autoincrement())
  name     String
  code     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sets     Set[]
  products Product[]

  @@map("languages")
}

model Set {
  id          Int       @id @default(autoincrement())
  gameId      Int
  game        Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  languageId  Int
  language    Language  @relation(fields: [languageId], references: [id])
  name        String
  slug        String
  code        String?
  description String?   @db.Text
  releaseDate DateTime?
  thumbnail   String?
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
  rarities Rarity[]

  @@unique([gameId, languageId, name])
  @@map("sets")
}

model Rarity {
  id        Int     @id @default(autoincrement())
  setId     Int
  set       Set     @relation(fields: [setId], references: [id], onDelete: Cascade)
  name      String
  shortName String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productVariants ProductVariant[]

  @@unique([setId, name])
  @@map("rarities")
}

model Condition {
  id          Int     @id @default(autoincrement())
  name        String
  shortName   String
  description String? @db.Text
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productVariants ProductVariant[]

  @@map("conditions")
}

enum ProductType {
  SINGLE_CARD
  SEALED_PRODUCT
  ACCESSORY
}

model SealedCategory {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String
  description String? @db.Text
  thumbnail   String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("sealed_categories")
}

model AccessoryCategory {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String
  description String? @db.Text
  thumbnail   String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("accessory_categories")
}

model Product {
  id          Int         @id @default(autoincrement())
  productType ProductType
  name        String
  slug        String      @unique
  description String?     @db.Text
  thumbnail   String?
  isActive    Boolean     @default(true)

  weight Int @default(100)

  gameId     Int?
  game       Game?     @relation(fields: [gameId], references: [id])
  setId      Int?
  set        Set?      @relation(fields: [setId], references: [id])
  languageId Int?
  language   Language? @relation(fields: [languageId], references: [id])

  cardNumber String?
  cardType   String?
  attribute  String?
  hp         Int?

  sealedCategoryId Int?
  sealedCategory   SealedCategory? @relation(fields: [sealedCategoryId], references: [id])
  cardsPerPack     Int?
  packsPerBox      Int?

  accessoryCategoryId Int?
  accessoryCategory   AccessoryCategory? @relation(fields: [accessoryCategoryId], references: [id])
  brand               String?
  size                String?
  color               String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  images        ProductImage[]
  variants      ProductVariant[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  wishlistItems Wishlist[]
  reviews       Review[]
  auctions      Auction[]  // ✅ CHANGED: One-to-many (was one-to-one)

  @@map("products")
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  rarityId Int?
  rarity   Rarity? @relation(fields: [rarityId], references: [id])

  conditionId Int?
  condition   Condition? @relation(fields: [conditionId], references: [id])

  price    Decimal @db.Decimal(12, 2)
  stock    Int     @default(0)
  sku      String? @unique
  isActive Boolean @default(true)

  weight Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cartItems  CartItem[]
  orderItems OrderItem[]
  auctions   Auction[]  // ✅ NEW: One variant can have multiple auctions

  @@unique([productId, rarityId, conditionId])
  @@map("product_variants")
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  isMain    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_images")
}

model Address {
  id            Int     @id @default(autoincrement())
  userId        Int
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  label         String
  recipientName String
  phoneNumber   String

  provinceId   Int
  provinceName String
  cityId       Int
  cityName     String

  street     String @db.Text
  postalCode String

  city     String?
  province String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("addresses")
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cartItems CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carts")
}

model CartItem {
  id        Int            @id @default(autoincrement())
  cartId    Int
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId Int
  product   Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int            @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, variantId])
  @@map("cart_items")
}

model Order {
  id          Int    @id @default(autoincrement())
  orderNumber String @unique
  userId      Int
  user        User   @relation(fields: [userId], references: [id])

  addressId Int
  address   Address @relation(fields: [addressId], references: [id])

  courier            String?
  courierCode        String?
  courierService     String?
  courierServiceName String?
  trackingNumber     String?
  estimatedDelivery  String?

  weight Int @default(0)

  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  paymentStatus PaymentStatus @default(UNPAID)
  paymentProof  String?
  bankName      String?
  accountNumber String?
  accountName   String?

  subtotal     Decimal @db.Decimal(12, 2)
  shippingCost Decimal @db.Decimal(12, 2)
  packagingFee Decimal @default(2500) @db.Decimal(12, 2)
  adminFee     Decimal @default(0) @db.Decimal(12, 2)
  discount     Decimal @default(0) @db.Decimal(12, 2)
  total        Decimal @db.Decimal(12, 2)

  status OrderStatus @default(PENDING)

  notes              String? @db.Text
  adminNotes         String? @db.Text
  cancellationReason String? @db.Text

  paymentDeadline DateTime? 

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  paidAt       DateTime?
  confirmedAt  DateTime?
  processingAt DateTime?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?

  orderItems    OrderItem[]
  statusHistory OrderStatusHistory[]
  complaints    Complaint[]
  auctions      Auction[]  

  @@index([paymentDeadline])  
  @@map("orders")
}

model OrderItem {
  id        Int            @id @default(autoincrement())
  orderId   Int
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product        @relation(fields: [productId], references: [id])
  variantId Int
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int
  price     Decimal        @db.Decimal(12, 2)
  subtotal  Decimal        @db.Decimal(12, 2)

  sourceType String? 
  sourceId   Int?    

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sourceType])  
  @@index([sourceId])    
  @@map("order_items")
}

model OrderStatusHistory {
  id        Int         @id @default(autoincrement())
  orderId   Int
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  notes     String?     @db.Text
  createdBy String?
  createdAt DateTime    @default(now())

  @@map("order_status_history")
}

enum OrderStatus {
  PENDING
  WAITING_FOR_PAYMENT
  WAITING_FOR_CONFIRMATION
  PAYMENT_REJECTED
  CONFIRMED
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  BANK_TRANSFER
  COD
  E_WALLET
  CREDIT_CARD
  QRIS
}

enum PaymentStatus {
  UNPAID
  PENDING_VERIFICATION
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

model Auction {
  id        Int     @id @default(autoincrement())
  productId Int     // ✅ REMOVED @unique - can have multiple auctions per product
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId Int            // ✅ NEW: Specific variant
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  quantity Int @default(1) // ✅ NEW: Amount to auction (always 1 for now)

  startPrice   Decimal @db.Decimal(12, 2)
  buyOutPrice  Decimal @db.Decimal(12, 2)
  currentBid   Decimal @db.Decimal(12, 2)
  minIncrement Decimal @default(10000) @db.Decimal(12, 2)

  startTime       DateTime
  lastBidTime     DateTime?
  endTime         DateTime?
  paymentDeadline DateTime?

  status AuctionStatus @default(ACTIVE)

  winnerId Int?
  winner   User? @relation("AuctionWinner", fields: [winnerId], references: [id])

  orderId Int? 
  order   Order? @relation(fields: [orderId], references: [id])

  isRelisted        Boolean   @default(false)
  originalAuctionId Int?
  originalAuction   Auction?  @relation("RelistedAuctions", fields: [originalAuctionId], references: [id], onDelete: SetNull)
  relistedAuctions  Auction[] @relation("RelistedAuctions")

  failureReason String?

  createdBy Int
  creator   User @relation("AuctionCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bids     Bid[]
  failures AuctionFailure[]

  @@index([productId])   
  @@index([variantId])   
  @@index([status])
  @@index([winnerId])    
  @@index([orderId])     
  @@index([endTime])
  @@index([paymentDeadline])
  @@map("auctions")
}

model Bid {
  id        Int      @id @default(autoincrement())
  auctionId Int
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bidAmount Decimal  @db.Decimal(12, 2)
  bidTime   DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([auctionId])
  @@index([userId])
  @@index([bidTime])
  @@map("bids")
}

model UserAuctionStats {
  id       Int  @id @default(autoincrement())
  userId   Int  @unique
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalWon    Int @default(0)
  totalPaid   Int @default(0)
  totalFailed Int @default(0)

  lastFailedAt DateTime?
  bannedUntil  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_auction_stats")
}

model AuctionFailure {
  id        Int     @id @default(autoincrement())
  auctionId Int
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  winnerId  Int
  winner    User    @relation(fields: [winnerId], references: [id], onDelete: Cascade)

  winningBid      Decimal  @db.Decimal(12, 2)
  paymentDeadline DateTime
  failedAt        DateTime @default(now())
  reason          String

  wasRelisted       Boolean @default(false)
  relistedAuctionId Int?

  adminNotes String? @db.Text

  createdAt DateTime @default(now())

  @@index([winnerId])
  @@index([failedAt])
  @@map("auction_failures")
}

enum AuctionStatus {
  ACTIVE
  ENDED
  PAYMENT_FAILED
  RELISTED
  PAID
  COMPLETED
  CANCELLED
}

model Wishlist {
  id        Int     @id @default(autoincrement())
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("wishlists")
}

model Review {
  id        Int     @id @default(autoincrement())
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating    Int
  comment   String  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("reviews")
}

model Complaint {
  id          Int              @id @default(autoincrement())
  orderId     Int
  order       Order            @relation(fields: [orderId], references: [id])
  userId      Int
  user        User             @relation("UserComplaints", fields: [userId], references: [id])

  type        ComplaintType
  description String           @db.Text

  videoUrl    String
  photos      ComplaintPhoto[]

  status      ComplaintStatus  @default(PENDING)

  adminNotes  String?          @db.Text
  adminId     Int?
  admin       User?            @relation("AdminComplaints", fields: [adminId], references: [id])

  resolution   ResolutionType?
  refundAmount Decimal?        @db.Decimal(12, 2)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reviewedAt  DateTime?
  resolvedAt  DateTime?

  @@map("complaints")
}

model ComplaintPhoto {
  id          Int       @id @default(autoincrement())
  complaintId Int
  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  url         String
  createdAt   DateTime  @default(now())

  @@map("complaint_photos")
}

enum ComplaintType {
  ITEM_DAMAGED
  WRONG_ITEM
  INCOMPLETE_ORDER
  FAKE_PRODUCT
  OTHER
}

enum ComplaintStatus {
  PENDING
  UNDER_INVESTIGATION
  APPROVED
  REJECTED
  RESOLVED
  CANCELLED
}

enum ResolutionType {
  REFUND
  REPLACE
  PARTIAL_REFUND
}

model BlogPost {
  id              Int       @id @default(autoincrement())
  title           String
  slug            String    @unique
  excerpt         String?   @db.Text
  content         String    @db.Text
  coverImage      String?

  authorId        Int
  author          User      @relation(fields: [authorId], references: [id])

  category        String?
  tags            String[]

  published       Boolean   @default(false)
  publishedAt     DateTime?

  viewCount       Int       @default(0)
  commentCount    Int       @default(0)

  metaTitle       String?
  metaDescription String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  comments        BlogComment[]

  @@map("blog_posts")
}

model BlogComment {
  id          Int          @id @default(autoincrement())
  postId      Int
  post        BlogPost     @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId      Int
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  content     String       @db.Text

  parentId    Int?
  parent      BlogComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     BlogComment[] @relation("CommentReplies")

  isEdited    Boolean      @default(false)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("blog_comments")
}